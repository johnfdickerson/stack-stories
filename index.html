<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack Stories 2.0 by John Dickerson</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .phone-frame {
            width: 375px;
            background: white;
            border-radius: 40px;
            border: 8px solid #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            max-height: 90vh;
        }
        .header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        .header h1 {
            font-size: 18px;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 12px;
            color: #666;
        }
        .column-header-row {
            display: grid;
            grid-template-columns: 25px 1fr 30px 1.2fr;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            font-size: 10px;
            background: #f9f9f9;
            align-items: center;
        }
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .story-row {
            display: grid;
            grid-template-columns: 25px 1fr 30px 1.2fr;
            gap: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: default;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            user-select: none;
            align-items: start;
        }
        .story-row:active {
            cursor: default;
        }
        .story-row.serious {
            background: white;
        }
        .story-row.joy {
            background: #FEF3C7;
        }
        .story-row.wonder {
            background: #EDE9FE;
        }
        .story-row.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .story-row.drag-over {
            border-top: 3px solid #0066cc;
        }
        .rank-number {
            font-size: 12px;
            font-weight: bold;
            color: #1a1a1a;
            text-align: center;
            line-height: 1.2;
            cursor: pointer;
            user-select: text;
        }
        .rank-number.revealed {
            font-size: 10px;
        }
        .drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            padding: 8px 8px;
            opacity: 0.6;
            transition: opacity 0.15s ease;
            touch-action: none;
            min-width: 30px;
        }
        .drag-handle:active {
            cursor: grabbing;
            opacity: 1;
        }
        .drag-handle:hover {
            opacity: 0.8;
        }
        .drag-handle-line {
            width: 4px;
            height: 35px;
            background: #555;
            border-radius: 2px;
            transition: all 0.15s ease;
        }
        .drag-handle.active,
        .drag-handle:active {
            opacity: 1;
        }
        .drag-handle.active .drag-handle-line,
        .drag-handle:active .drag-handle-line {
            background: #0066cc;
            width: 5px;
        }
        .story-row.dragging .drag-handle {
            opacity: 1;
        }
        .story-row.dragging .drag-handle-line {
            background: #0066cc;
            width: 5px;
        }
        .story-title {
            cursor: pointer;
            user-select: text;
        }
        .story-title a {
            color: #0066cc;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            line-height: 1.2;
        }
        .story-title a:hover {
            text-decoration: underline;
        }
        .reason-label {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .reason-label.expanded {
            -webkit-line-clamp: unset;
            overflow: visible;
        }
        .story-type-tag {
            display: inline-block;
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .story-type-tag.joy {
            background: #fbbf24;
            color: #78350f;
        }
        .story-type-tag.wonder {
            background: #a78bfa;
            color: #4c1d95;
        }
        .reason-more {
            font-size: 10px;
            color: #0066cc;
            cursor: pointer;
            font-weight: 500;
            margin-top: 2px;
            display: inline-block;
        }
        .sources-container {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: none;
        }
        .sources-container.visible {
            display: block;
        }
        .sources-label {
            font-size: 9px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .source-link {
            font-size: 9px;
            padding: 2px 6px;
            background: #e8f1ff;
            color: #0066cc;
            border-radius: 3px;
            text-decoration: none;
            cursor: pointer;
            border: 1px solid #b3d9ff;
            transition: all 0.2s;
        }
        .source-link:hover {
            background: #0066cc;
            color: white;
        }
        .info-text {
            padding: 12px 16px;
            font-size: 11px;
            color: #444;
            border-top: 1px solid #eee;
            min-height: 40px;
            line-height: 1.4;
        }
        .footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid #eee;
        }
        button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-vote {
            background: #0066cc;
            color: white;
        }
        .btn-vote:hover {
            background: #0052a3;
        }
        .btn-reset {
            background: #f0f0f0;
            color: #333;
        }
        .btn-reset:hover {
            background: #e0e0e0;
        }
        .btn-my-picks {
            background: #8b5cf6;
            color: white;
        }
        .btn-my-picks:hover {
            background: #7c3aed;
        }
        .btn-jd-picks {
            background: #f59e0b;
            color: white;
        }
        .btn-jd-picks:hover {
            background: #d97706;
        }
        .btn-compare {
            background: #10b981;
            color: white;
        }
        .btn-compare:hover {
            background: #059669;
        }
        .btn-compare:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .number-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .number-picker-overlay.active {
            display: flex;
        }
        .number-picker {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .number-picker h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #333;
        }
        .number-wheel {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 280px;
            margin-bottom: 16px;
        }
        .number-option {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .number-option:hover {
            background: #e0e0e0;
            border-color: #0066cc;
        }
        .number-option.current {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        .picker-buttons {
            display: flex;
            gap: 8px;
        }
        .picker-buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="header">
            <h1>Stack Stories 2.0</h1>
            <p>by John Dickerson</p>
            <p style="font-size: 11px; margin-top: 4px;">November 9, 2025</p>
        </div>
        <div class="column-header-row">
            <div>#</div>
            <div>Story</div>
            <div></div>
            <div>Reason</div>
        </div>
        <div class="content" id="storyList">
            <!-- Stories will be generated here -->
        </div>
        <div class="info-text" id="infoText">
            Rank today's news by importance: Hold & drag | to reorder • Click # to jump • Tap title for sources • Compare to see JD's ranking
        </div>
        <div class="footer">
            <button class="btn-reset" onclick="resetOrder()">Reset</button>
            <button class="btn-my-picks" onclick="showMyPicks()">My Picks</button>
            <button class="btn-jd-picks" onclick="showJDPicks()">JD Picks</button>
            <button class="btn-compare" onclick="compareRankings()">Compare to JD</button>
        </div>
    </div>
    
    <div class="number-picker-overlay" id="numberPickerOverlay" onclick="if(event.target === this) closeNumberPicker()">
        <div class="number-picker">
            <h3>Select Rank</h3>
            <div class="number-wheel" id="numberWheel">
                <!-- Numbers 1-11 will be generated here -->
            </div>
            <div class="picker-buttons">
                <button class="btn-reset" onclick="closeNumberPicker()">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        const originalStories = [
            {
                        "rank": 1,
                        "title": "Trump: States 'Undo' SNAP Payouts.",
                        "reason": "42 million Americans depend on SNAP. Newest test in battle between Executive and Judicial branches. Political pain of hunger increases human stakes of political fight.",
                        "reasonExpanded": "Lower courts forced payments, saying admin's refusal \"arbitrary and capricious\" causing \"irreparable harm\". Some states paid out benefits. Then SCOTUS (Jackson) issued a temporary \"administrative stay\"—not a ruling on the merits—based on the \"separation of powers\" argument that judges can't \"dictate... how scarce federal funds should be spent\". Then Admin. asked state to \"undo,\" what they'd paid.",
                        "type": "serious",
                        "newsRank": "1st",
                        "communityRank": "1st",
                        "sources": [
                                    {
                                                "outlet": "Indian Express",
                                                "url": "https://indianexpress.com/article/world/trump-administration-demands-states-undo-full-snap-payouts-as-states-warn-of-catastrophic-impact-10355912/"
                                    },
                                    {
                                                "outlet": "OPB",
                                                "url": "https://www.opb.org/article/2025/11/09/trump-administration-demands-states-undo-full-snap-payouts-as-states-warn-of-catastrophic-impact/"
                                    }
                        ]
            },
            {
                        "rank": 2,
                        "title": "Flight Cancellations",
                        "reason": "3.5 million affected; 2,500 flights cancelled.",
                        "reasonExpanded": "Straining systems. 25% of Americans travel once a year. Wider population than those who receive direct benefits. Affects wider economic activity. Could change political dynamic. Previous shutdowns ended when travel snarls were caused.",
                        "type": "serious",
                        "newsRank": "2nd",
                        "communityRank": "2nd",
                        "sources": [
                                    {
                                                "outlet": "AP News",
                                                "url": "https://apnews.com/article/shutdown-reduced-flights-what-to-know-a7feaf54f65567d180ae5a232cb0bcb4"
                                    },
                                    {
                                                "outlet": "Star Tribune",
                                                "url": "https://www.startribune.com/travelers-soldier-on-through-msp-delays-cancellations/601520377"
                                    },
                                    {
                                                "outlet": "The Guardian",
                                                "url": "https://www.theguardian.com/us-news/2025/nov/08/flight-cancellations-government-shutdown"
                                    }
                        ]
            },
            {
                        "rank": 3,
                        "title": "Ukraine Tripple Threat.",
                        "reason": "Russian launch of 450+ missiles and drones targeting two nuclear plants risks a catastrophic meltdown that poisons the continent of Europe. Territory of Pokrovsk is slipping. U.S. shutdown cut off $5 billion in weapons so they can't effectively shoot back.",
                        "reasonExpanded": "That barrage is a massive (sign of Russ. Capacity). Loss of life: at least seven people. 16-hour power cuts. Pokrovsk's a breach of Ukraine's eastern front in the Donetsk region.",
                        "type": "serious",
                        "newsRank": "3rd",
                        "communityRank": "3rd",
                        "sources": [
                                    {
                                                "outlet": "Al Jazeera",
                                                "url": "https://www.aljazeera.com/news/2025/11/09/russia-ukraine-war-list-of-key-events-day-1354"
                                    },
                                    {
                                                "outlet": "RNZ",
                                                "url": "https://www.rnz.co.nz/news/world/578314/russian-attacks-target-nuclear-substations-kill-seven-ukraine-says"
                                    }
                        ]
            },
            {
                        "rank": 4,
                        "title": "A House-Size Spider Web",
                        "reason": "Universal zing of spider stories. Natural wonder.",
                        "reasonExpanded": "The story's significance is not in its political or economic weight, but in its total lack of it. It functions as an essential \"palate cleanser\" for a serious news diet.",
                        "type": "wonder",
                        "newsRank": "4th",
                        "communityRank": "4th",
                        "sources": [
                                    {
                                                "outlet": "Times of India",
                                                "url": "https://timesofindia.indiatimes.com/world/europe/worlds-largest-spiderweb-found-in-europe-over-111000-spiders-inside/articleshow/125109293.cms"
                                    },
                                    {
                                                "outlet": "Indian Express",
                                                "url": "https://indianexpress.com/article/lifestyle/pets-animals/the-worlds-largest-spider-web-spread-across-roughly-1140-square-feet-found-in-a-hidden-sulfur-cave-10352619/"
                                    }
                        ]
            },
            {
                        "rank": 5,
                        "title": "U.S. Federal Judge Resigns.",
                        "reason": "Judges don't usually resign in this fashion. Reagan appointee diminishes charges of rank partisanship. Writing in The Atlantic, accuses Trump of \"using the law for partisan purposes.\" Protecting friends. Targeting enemies strikes at core of government functions.",
                        "reasonExpanded": "Significant data point in ongoing battle between Trump and courts.",
                        "type": "serious",
                        "newsRank": "5th",
                        "communityRank": "5th",
                        "sources": [
                                    {
                                                "outlet": "India Today",
                                                "url": "https://www.indiatoday.in/world/us-news/story/mark-wolf-resigns-federal-judge-condemns-trump-partisan-law-use-glbs-2816344-2025-11-10"
                                    },
                                    {
                                                "outlet": "Bloomberg Law",
                                                "url": "https://news.bloomberglaw.com/us-law-week/reagan-judge-says-he-quit-bench-to-speak-out-against-trump"
                                    }
                        ]
            },
            {
                        "rank": 6,
                        "title": "2016 Russia Probe officials subpoenaed.",
                        "reason": "This escalates the Trump administration's investigation of those who investigated him. Subpoenaed: former CIA Director John Brennan, former FBI officials Peter Strzok and Lisa Page, and former Director of National Intelligence James Clapper.",
                        "reasonExpanded": "The subpoenas are part of a stated \"retribution campaign\" against Trump's \"political adversaries\". The investigation is pursuing a \"grand conspiracy\" theory that sources say is \"unsupported by the evidence\". This same campaign has raised concerns in the Senate about a potential indictment of Sen. Adam Schiff.",
                        "type": "serious",
                        "newsRank": "6th",
                        "communityRank": "6th",
                        "sources": [
                                    {
                                                "outlet": "CBS News",
                                                "url": "https://www.cbsnews.com/news/grand-jury-cia-john-brennan-fbi-officials-trump-russia-probe-subpoena/"
                                    },
                                    {
                                                "outlet": "Washington Examiner",
                                                "url": "https://www.washingtonexaminer.com/news/justice/3880049/john-brennan-other-officials-subpoenaed-trump-russia-probe/"
                                    },
                                    {
                                                "outlet": "The Print",
                                                "url": "https://theprint.in/world/former-cia-boss-ex-fbi-officials-subpoenaed-in-doj-probe-fox-news-digital-reports/2779761/"
                                    }
                        ]
            },
            {
                        "rank": 7,
                        "title": "Infants with Botulism/Formula recall.",
                        "reason": "13 kids hospitalized in 10 states. ByHeart formula poses direct threat to infants. Parents need immediate action.",
                        "reasonExpanded": "No such thing as \"a little light botulism.\" it's a form of paralysis caused by a potent neurotoxin. Requires intensive care. Ten states is a lot. Infant botulism is very rare. When you suddenly get 13 cases across 10 states (Arizona, California, Illinois, Minnesota, New Jersey, Oregon, Pennsylvania, Rhode Island, Texas, and Washington) all linked to one product, it signals a systemic failure.",
                        "type": "serious",
                        "newsRank": "6th",
                        "communityRank": "6th",
                        "sources": [
                                    {
                                                "outlet": "CDC",
                                                "url": "https://www.cdc.gov/botulism/outbreaks-investigations/infant-formula-nov-2025/investigation.html"
                                    },
                                    {
                                                "outlet": "Times of India",
                                                "url": "https://timesofindia.indiatimes.com/life-style/health-fitness/health-news/infants-fall-sick-in-10-us-states-after-consuming-popular-baby-formula/articleshow/125199640.cms"
                                    }
                        ]
            },
            {
                        "rank": 8,
                        "title": "White-Collar Job Market Freezes; Shutdown Blinds Analysts",
                        "reason": "A key economic indicator, tech hiring, is down 27% year-over-year. The 40-day shutdown has blocked the official jobs report for \"two consecutive months\", meaning Federal Reserve and businesses can't plan or take measures to avoid a recession if one is coming.",
                        "reasonExpanded": "Signal of a \"bipolar economy\": AI and Wall Street are thriving while \"a lot of the middle class is getting hit\". Businesses state they aren't hiring. Connecticut Gov. Lamont, whose state's economy is tied to the financial sector, warned these are \"the early signs of what could be a potential recession\" as laid-off \"Corporate America\" workers face a \"hellish job market\".",
                        "type": "serious",
                        "newsRank": "8th",
                        "communityRank": "8th",
                        "sources": [
                                    {
                                                "outlet": "Investopedia",
                                                "url": "https://www.investopedia.com/data-drought-deepens-as-second-key-jobs-report-goes-unreported-11844989"
                                    }
                        ]
            },
            {
                        "rank": 9,
                        "title": "NYT: US part of UN-Defined Torture",
                        "reason": "The U.S. government is now implicated in torture.",
                        "reasonExpanded": "A NYT investigation found that 200+ Venezuelan men deported by the U.S. to an El Salvadoran prison were beaten and sexually assaulted by guards. An independent forensic analysis concluded these acts meet the UN's definition of torture. This isn't an isolated event; it's a direct consequence of the administration's immigration policy which has taken a hard line, including: ending Temporary Protected Status for 600,000 Venezuelans, conducting a \"two-month\" immigration crackdown in cities like Chicago, and deporting undocumented immigrants \"without due process\".",
                        "type": "serious",
                        "newsRank": "9th",
                        "communityRank": "9th",
                        "sources": [
                                    {
                                                "outlet": "NILC",
                                                "url": "https://www.nilc.org/resources/tracking-the-cecot-disappearances/"
                                    },
                                    {
                                                "outlet": "Latin News",
                                                "url": "https://www.latinnews.com/component/k2/item/106581-venezuela-investigation-into-alleged-torture-of-deportees-in-el-salvador.html"
                                    },
                                    {
                                                "outlet": "Human Rights First",
                                                "url": "https://humanrightsfirst.org/library/uzra-zeyas-remarks-at-the-universal-periodic-review-side-event/"
                                    }
                        ]
            },
            {
                        "rank": 10,
                        "title": "Hamas Returns Remains of Israeli Soldier.",
                        "reason": "Under U.S.-brokered peace deal, Hamas committed to returning 28 sets of remains. This brings \"bitter closure\" to an 11-year national ordeal for Israel and is also a key test of the current, rocky ceasefire.",
                        "reasonExpanded": "Israel accuses Hamas of slow-walking for leverage, while Hamas claims delays are due to the difficulty of digging up bodies from rubble. How that dispute gets resolved will determine if peace deal holds.",
                        "type": "serious",
                        "newsRank": "9th",
                        "communityRank": "9th",
                        "sources": [
                                    {
                                                "outlet": "Washington Examiner",
                                                "url": "https://www.washingtonexaminer.com/news/world/3880436/hamas-returns-body-israeli-soldier-2014"
                                    },
                                    {
                                                "outlet": "FDD",
                                                "url": "https://www.fdd.org/analysis/2025/11/10/remains-of-idf-officer-held-captive-by-hamas-for-more-than-a-decade-finally-released/"
                                    }
                        ]
            },
            {
                        "rank": 11,
                        "title": "Robot Woks in Los Angeles",
                        "reason": "An \"automatic woks\" is no work at all. Not just Gee Whiz, but a story of innovation to the familiar, everyday experience of dining.",
                        "reasonExpanded": "This is a high-diversion story that succeeds by being low-stakes and fascinating. Its value comes from its focus on invention in a relatable, non-political space (food).",
                        "type": "joy",
                        "newsRank": "11th",
                        "communityRank": "11th",
                        "sources": [
                                    {
                                                "outlet": "RoboWok",
                                                "url": "http://robowok.net/Aboutus.aspx?ClassID=2"
                                    },
                                    {
                                                "outlet": "BC RE LA",
                                                "url": "https://bcre.la/the-robots-are-coming-for-chinese-food-next/"
                                    },
                                    {
                                                "outlet": "LA Voice",
                                                "url": "https://lavoice.com/los-angeles-restaurant-tigawok-brings-chinese-food-and-robots-together/"
                                    }
                        ]
            }
];
        const stories = JSON.parse(JSON.stringify(originalStories));
        
        // Shuffle function using Fisher-Yates algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Start with scrambled order and save it for reset
        let initialScrambledOrder = shuffleArray(stories);
        let currentOrder = [...initialScrambledOrder];
        let myPicks = null; // Store user's saved ranking
        let draggedElement = null;
        let draggedIndex = null;
        let rankingsRevealed = false;
        let currentPickerIndex = null;
        
        window.addEventListener('DOMContentLoaded', () => {
            renderStories();
            initNumberPicker();
        });
        function renderStories() {
            const storyList = document.getElementById('storyList');
            storyList.innerHTML = '';
            currentOrder.forEach((story, index) => {
                const storyRow = document.createElement('div');
                storyRow.className = 'story-row ' + story.type;
                storyRow.id = 'story-' + index;
                
                // Rank number with long-press
                const rankDiv = document.createElement('div');
                rankDiv.className = 'rank-number';
                rankDiv.id = 'rank-display-' + index;
                rankDiv.textContent = (index + 1);
                rankDiv.title = 'Click to select rank';
                
                // Click/tap to open number picker
                rankDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openNumberPicker(index);
                });
                
                storyRow.appendChild(rankDiv);
                
                // Story title
                const titleDiv = document.createElement('div');
                titleDiv.className = 'story-title';
                titleDiv.style.cursor = 'pointer';
                titleDiv.innerHTML = '<a href="#">' + escapeHtml(story.title) + '</a>';
                titleDiv.onclick = function(e) {
                    e.stopPropagation();
                    toggleSources(index);
                };
                storyRow.appendChild(titleDiv);
                
                // Drag handle
                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle';
                dragHandle.innerHTML = '<div class="drag-handle-line"></div>';
                storyRow.appendChild(dragHandle);
                
                // Reason section
                const reasonDiv = document.createElement('div');
                const reasonLabel = document.createElement('div');
                reasonLabel.className = 'reason-label ' + story.type;
                reasonLabel.id = 'reason-' + index;
                
                // Add type tag for joy/wonder stories
                if (story.type === 'joy' || story.type === 'wonder') {
                    const typeTag = document.createElement('span');
                    typeTag.className = 'story-type-tag ' + story.type;
                    typeTag.textContent = story.type;
                    reasonLabel.appendChild(typeTag);
                }
                
                // Add text content
                const textNode = document.createTextNode(story.reason);
                reasonLabel.appendChild(textNode);
                
                const moreButton = document.createElement('span');
                moreButton.className = 'reason-more';
                moreButton.textContent = 'more';
                moreButton.onclick = function(e) { 
                    e.stopPropagation();
                    toggleReason(e, index); 
                };
                reasonDiv.appendChild(reasonLabel);
                reasonDiv.appendChild(moreButton);
                
                // Sources container
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'sources-container';
                sourcesContainer.id = 'sources-' + index;
                
                if (story.sources && story.sources.length > 0) {
                    const sourcesLabel = document.createElement('div');
                    sourcesLabel.className = 'sources-label';
                    sourcesLabel.textContent = 'Sources';
                    sourcesContainer.appendChild(sourcesLabel);
                    
                    const sourcesList = document.createElement('div');
                    sourcesList.className = 'sources-list';
                    
                    story.sources.forEach(source => {
                        const sourceLink = document.createElement('a');
                        sourceLink.className = 'source-link';
                        sourceLink.textContent = source.outlet;
                        sourceLink.href = source.url;
                        sourceLink.target = '_blank';
                        sourceLink.rel = 'noopener noreferrer';
                        sourceLink.onclick = function(e) {
                            e.stopPropagation();
                        };
                        sourcesList.appendChild(sourceLink);
                    });
                    
                    sourcesContainer.appendChild(sourcesList);
                }
                reasonDiv.appendChild(sourcesContainer);
                storyRow.appendChild(reasonDiv);
                
                // Drag events - ONLY on drag handle for desktop
                dragHandle.draggable = true;
                dragHandle.addEventListener('dragstart', (e) => {
                    draggedElement = storyRow;
                    draggedIndex = index;
                    setTimeout(() => storyRow.classList.add('dragging'), 0);
                    if (e.dataTransfer) {
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });
                
                storyRow.addEventListener('dragend', (e) => {
                    storyRow.classList.remove('dragging');
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                });
                
                storyRow.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer) {
                        e.dataTransfer.dropEffect = 'move';
                    }
                    if (draggedElement && draggedElement !== storyRow) {
                        storyRow.classList.add('drag-over');
                    }
                });
                
                storyRow.addEventListener('dragleave', (e) => {
                    storyRow.classList.remove('drag-over');
                });
                
                storyRow.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== storyRow) {
                        const allRows = [...document.querySelectorAll('.story-row')];
                        const draggedIdx = allRows.indexOf(draggedElement);
                        const targetIdx = allRows.indexOf(storyRow);
                        
                        [currentOrder[draggedIdx], currentOrder[targetIdx]] = 
                        [currentOrder[targetIdx], currentOrder[draggedIdx]];
                        
                        renderStories();
                    }
                    storyRow.classList.remove('drag-over');
                });
                
                // Touch events - ONLY on drag handle for mobile
                let touchStartX = 0;
                let touchStartY = 0;
                let isTouchDragging = false;
                let touchMoved = false;
                let touchTimer = null;
                
                dragHandle.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    isTouchDragging = false;
                    touchMoved = false;
                    
                    // Immediate visual feedback
                    dragHandle.classList.add('active');
                    dragHandle.style.opacity = '1';
                    storyRow.style.transform = 'scale(1.02)';
                    storyRow.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                }, {passive: true});
                
                dragHandle.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    const threshold = 5;
                    
                    if (deltaX > threshold || deltaY > threshold) {
                        touchMoved = true;
                    }
                    
                    if (touchMoved && !isTouchDragging) {
                        isTouchDragging = true;
                        draggedElement = storyRow;
                        draggedIndex = index;
                        storyRow.classList.add('dragging');
                    }
                    
                    if (isTouchDragging) {
                        e.preventDefault();
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetRow = elementBelow?.closest('.story-row');
                        
                        document.querySelectorAll('.story-row').forEach(row => {
                            row.classList.remove('drag-over');
                        });
                        
                        if (targetRow && targetRow !== storyRow) {
                            targetRow.classList.add('drag-over');
                        }
                    }
                }, {passive: false});
                
                dragHandle.addEventListener('touchend', (e) => {
                    // Reset visual feedback
                    dragHandle.classList.remove('active');
                    dragHandle.style.opacity = '';
                    storyRow.style.transform = '';
                    storyRow.style.boxShadow = '';
                    
                    if (isTouchDragging) {
                        e.preventDefault();
                        const touch = e.changedTouches[0];
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetRow = elementBelow?.closest('.story-row');
                        
                        if (targetRow && targetRow !== draggedElement) {
                            const allRows = [...document.querySelectorAll('.story-row')];
                            const draggedIdx = allRows.indexOf(draggedElement);
                            const targetIdx = allRows.indexOf(targetRow);
                            
                            if (draggedIdx !== -1 && targetIdx !== -1) {
                                [currentOrder[draggedIdx], currentOrder[targetIdx]] = 
                                [currentOrder[targetIdx], currentOrder[draggedIdx]];
                                
                                renderStories();
                            }
                        }
                    }
                    
                    isTouchDragging = false;
                    touchMoved = false;
                    draggedElement = null;
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over', 'dragging');
                    });
                }, {passive: false});
                
                dragHandle.addEventListener('touchcancel', (e) => {
                    // Reset visual feedback
                    dragHandle.classList.remove('active');
                    dragHandle.style.opacity = '';
                    storyRow.style.transform = '';
                    storyRow.style.boxShadow = '';
                    
                    isTouchDragging = false;
                    touchMoved = false;
                    draggedElement = null;
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over', 'dragging');
                    });
                });
                
                storyList.appendChild(storyRow);
            });
        }
        function toggleSources(index) {
            const sourcesContainer = document.getElementById('sources-' + index);
            if (sourcesContainer) {
                sourcesContainer.classList.toggle('visible');
            }
        }
        function toggleReason(event, index) {
            event.stopPropagation();
            const reasonLabel = document.getElementById('reason-' + index);
            const moreButton = event.target;
            const storyData = stories.find(s => s.rank === currentOrder[index].rank);
            
            if (reasonLabel.classList.contains('expanded')) {
                reasonLabel.classList.remove('expanded');
                
                // Clear and rebuild with just reason text
                reasonLabel.innerHTML = '';
                if (storyData.type === 'joy' || storyData.type === 'wonder') {
                    const typeTag = document.createElement('span');
                    typeTag.className = 'story-type-tag ' + storyData.type;
                    typeTag.textContent = storyData.type;
                    reasonLabel.appendChild(typeTag);
                }
                reasonLabel.appendChild(document.createTextNode(storyData.reason));
                
                moreButton.textContent = 'more';
            } else {
                reasonLabel.classList.add('expanded');
                
                // Clear and rebuild with full text
                reasonLabel.innerHTML = '';
                if (storyData.type === 'joy' || storyData.type === 'wonder') {
                    const typeTag = document.createElement('span');
                    typeTag.className = 'story-type-tag ' + storyData.type;
                    typeTag.textContent = storyData.type;
                    reasonLabel.appendChild(typeTag);
                }
                const combinedText = storyData.reason + '\n\n' + storyData.reasonExpanded;
                reasonLabel.appendChild(document.createTextNode(combinedText));
                
                moreButton.textContent = 'less';
            }
        }
        function resetOrder() {
            currentOrder = JSON.parse(JSON.stringify(initialScrambledOrder));
            rankingsRevealed = false;
            renderStories();
            updateInfoText("Back to scrambled order");
        }
        
        function showMyPicks() {
            if (!myPicks) {
                // First time: save current order
                myPicks = JSON.parse(JSON.stringify(currentOrder));
                updateInfoText("Your ranking saved! Click again to restore it.");
            } else {
                // Check if current order matches saved picks
                const currentJSON = JSON.stringify(currentOrder.map(s => s.rank));
                const savedJSON = JSON.stringify(myPicks.map(s => s.rank));
                
                if (currentJSON === savedJSON) {
                    // Already showing saved picks, so update the save
                    myPicks = JSON.parse(JSON.stringify(currentOrder));
                    updateInfoText("Your ranking updated!");
                } else {
                    // Different order, so restore saved picks
                    currentOrder = JSON.parse(JSON.stringify(myPicks));
                    updateInfoText("Restored your saved ranking");
                }
            }
            rankingsRevealed = false;
            renderStories();
        }
        
        function showJDPicks() {
            // Show John's original ranking (sorted by rank field)
            currentOrder = JSON.parse(JSON.stringify(originalStories));
            rankingsRevealed = false;
            renderStories();
            updateInfoText("Showing JD's ranking");
        }
        
        function compareRankings() {
            rankingsRevealed = !rankingsRevealed;
            
            currentOrder.forEach((story, userIndex) => {
                const rankDisplay = document.getElementById('rank-display-' + userIndex);
                const userRank = userIndex + 1;
                const jdRank = story.rank;
                
                if (rankingsRevealed) {
                    rankDisplay.classList.add('revealed');
                    rankDisplay.textContent = userRank + ' / JD:' + jdRank;
                    rankDisplay.title = 'Your rank / JD\'s rank';
                } else {
                    rankDisplay.classList.remove('revealed');
                    rankDisplay.textContent = userRank;
                    rankDisplay.title = 'Click to select rank';
                }
            });
            
            if (rankingsRevealed) {
                // Calculate differences and generate summary
                const differences = currentOrder.map((story, userIndex) => ({
                    story: story,
                    userRank: userIndex + 1,
                    jdRank: story.rank,
                    diff: Math.abs((userIndex + 1) - story.rank)
                }));
                
                // Sort by biggest difference
                differences.sort((a, b) => b.diff - a.diff);
                
                // Find stories that moved most
                const biggest = differences[0];
                const secondBiggest = differences[1];
                
                let summary = '';
                
                if (biggest.diff === 0) {
                    summary = 'Perfect match! You and JD ranked all stories identically.';
                } else {
                    // First sentence: biggest mover
                    const biggestDir = biggest.userRank < biggest.jdRank ? 'higher' : 'lower';
                    const biggestTitle = biggest.story.title.length > 40 ? 
                        biggest.story.title.substring(0, 40) + '...' : 
                        biggest.story.title;
                    summary = `Your biggest difference: you ranked "${biggestTitle}" ${biggestDir} (#${biggest.userRank} vs JD's #${biggest.jdRank}). `;
                    
                    // Second sentence: second biggest or overall agreement
                    const exactMatches = differences.filter(d => d.diff === 0).length;
                    if (exactMatches > 0) {
                        summary += `You agreed on ${exactMatches} ${exactMatches === 1 ? 'story' : 'stories'} exactly.`;
                    } else if (secondBiggest.diff > 0) {
                        const secondDir = secondBiggest.userRank < secondBiggest.jdRank ? 'higher' : 'lower';
                        const secondTitle = secondBiggest.story.title.length > 40 ? 
                            secondBiggest.story.title.substring(0, 40) + '...' : 
                            secondBiggest.story.title;
                        summary += `Also notable: "${secondTitle}" ranked ${secondDir} (#${secondBiggest.userRank} vs #${secondBiggest.jdRank}).`;
                    }
                }
                
                updateInfoText(summary, true);
            } else {
                updateInfoText("");
            }
        }
        
        function updateInfoText(message, isPersistent = false) {
            const infoText = document.getElementById('infoText');
            if (message) {
                // Don't make comparison summaries bold since they're longer
                if (isPersistent) {
                    infoText.textContent = message;
                } else {
                    infoText.innerHTML = '<strong>' + escapeHtml(message) + '</strong>';
                }
                
                if (!isPersistent) {
                    setTimeout(() => {
                        infoText.textContent = 'Rank today\'s news by importance: Hold & drag | to reorder • Click # to jump • Tap title for sources • Compare to see JD\'s ranking';
                    }, 2000);
                }
            } else {
                infoText.textContent = 'Rank today\'s news by importance: Hold & drag | to reorder • Click # to jump • Tap title for sources • Compare to see JD\'s ranking';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function initNumberPicker() {
            const numberWheel = document.getElementById('numberWheel');
            for (let i = 1; i <= 11; i++) {
                const numOption = document.createElement('div');
                numOption.className = 'number-option';
                numOption.textContent = i;
                numOption.onclick = () => selectRank(i);
                numberWheel.appendChild(numOption);
            }
        }
        
        function openNumberPicker(index) {
            currentPickerIndex = index;
            const overlay = document.getElementById('numberPickerOverlay');
            overlay.classList.add('active');
            
            // Highlight current position
            const currentRank = index + 1;
            document.querySelectorAll('.number-option').forEach((opt, i) => {
                if (i + 1 === currentRank) {
                    opt.classList.add('current');
                } else {
                    opt.classList.remove('current');
                }
            });
        }
        
        function closeNumberPicker() {
            document.getElementById('numberPickerOverlay').classList.remove('active');
            currentPickerIndex = null;
        }
        
        function selectRank(newRank) {
            if (currentPickerIndex === null) return;
            
            const oldIndex = currentPickerIndex;
            const newIndex = newRank - 1;
            
            if (oldIndex !== newIndex) {
                // Remove item from old position
                const item = currentOrder.splice(oldIndex, 1)[0];
                // Insert at new position
                currentOrder.splice(newIndex, 0, item);
                renderStories();
            }
            
            closeNumberPicker();
        }
    </script>
</body>
</html>
