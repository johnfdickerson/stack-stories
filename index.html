<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack Stories 3.0 by John Dickerson</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .phone-frame {
            width: 375px;
            background: white;
            border-radius: 40px;
            border: 8px solid #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            max-height: 90vh;
        }
        .header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        .header h1 {
            font-size: 18px;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 12px;
            color: #666;
        }
        .column-header-row {
            display: grid;
            grid-template-columns: 35px 1fr;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            font-size: 10px;
            background: #f9f9f9;
            align-items: center;
        }
        .instructions-row {
            padding: 10px 16px;
            border-bottom: 1px solid #ddd;
            font-size: 10px;
            background: #f9f9f9;
            color: #444;
            line-height: 1.4;
            text-align: center;
        }
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }
        .story-row {
            display: grid;
            grid-template-columns: 35px 1fr;
            gap: 12px;
            padding: 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            user-select: none;
            align-items: start;
            cursor: grab;
        }
        .story-row:active {
            cursor: grabbing;
        }
        .story-row.serious {
            background: white;
        }
        .story-row.joy {
            background: #FEF3C7;
        }
        .story-row.wonder {
            background: #EDE9FE;
        }
        .story-row.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .story-row.drag-over {
            border-top: 3px solid #0066cc;
        }
        .rank-number {
            font-size: 14px;
            font-weight: bold;
            color: #1a1a1a;
            text-align: center;
            line-height: 1.2;
            cursor: pointer;
            user-select: text;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.15s ease;
            touch-action: none;
            pointer-events: auto;
        }
        .rank-number:active {
            background: #e0e0e0;
            transform: scale(1.1);
        }
        .rank-number.revealed {
            font-size: 10px;
        }
        .story-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .story-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .story-title {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            line-height: 1.3;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 0;
        }
        .story-title-text {
            flex: 1;
            min-width: 0;
        }
        .more-button {
            font-size: 11px;
            color: #0066cc;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            user-select: none;
            pointer-events: auto;
        }
        .more-button:hover {
            text-decoration: underline;
        }
        .expanded-content {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .expanded-content.visible {
            display: block;
        }
        .story-type-tag {
            display: inline-block;
            font-size: 8px;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-shrink: 0;
        }
        .story-type-tag.joy {
            background: #fbbf24;
            color: #78350f;
        }
        .story-type-tag.wonder {
            background: #a78bfa;
            color: #4c1d95;
        }
        .reason-text {
            font-size: 11px;
            color: #444;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .expanded-reason-text {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .sources-container {
            margin-top: 8px;
        }
        .sources-label {
            font-size: 9px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .source-link {
            font-size: 9px;
            padding: 2px 6px;
            background: #e8f1ff;
            color: #0066cc;
            border-radius: 3px;
            text-decoration: none;
            cursor: pointer;
            border: 1px solid #b3d9ff;
            transition: all 0.2s;
        }
        .source-link:hover {
            background: #0066cc;
            color: white;
        }
        .info-text {
            padding: 12px 16px;
            font-size: 11px;
            color: #444;
            border-top: 1px solid #eee;
            min-height: 0;
            line-height: 1.4;
            display: none;
        }
        .footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid #eee;
        }
        button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-reset {
            background: #f0f0f0;
            color: #333;
        }
        .btn-reset:hover {
            background: #e0e0e0;
        }
        .btn-my-picks {
            background: #8b5cf6;
            color: white;
        }
        .btn-my-picks:hover {
            background: #7c3aed;
        }
        .btn-jd-picks {
            background: #f59e0b;
            color: white;
        }
        .btn-jd-picks:hover {
            background: #d97706;
        }
        .btn-compare {
            background: #10b981;
            color: white;
        }
        .btn-compare:hover {
            background: #059669;
        }
        .number-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .number-picker-overlay.active {
            display: flex;
        }
        .number-picker {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .number-picker h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #333;
        }
        .number-wheel {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 280px;
            margin-bottom: 16px;
        }
        .number-option {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .number-option:hover {
            background: #e0e0e0;
            border-color: #0066cc;
        }
        .number-option.current {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        .picker-buttons {
            display: flex;
            gap: 8px;
        }
        .picker-buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="header">
            <h1>Stack Stories 3.0</h1>
            <p>by John Dickerson</p>
            <p style="font-size: 11px; margin-top: 4px;">November 9, 2025</p>
        </div>
        <div class="instructions-row">
            Rank today's news: Drag story to reorder • Click # to jump • Click "more" for details
        </div>
        <div class="content" id="storyList">
            <!-- Stories will be generated here -->
        </div>
        <div class="info-text" id="infoText">
            Rank today's news: Drag story to reorder • Click # to jump • Click "more" for details
        </div>
        <div class="footer">
            <button class="btn-reset" onclick="resetOrder()">Reset</button>
            <button class="btn-my-picks" onclick="showMyPicks()">My Picks</button>
            <button class="btn-jd-picks" onclick="showJDPicks()">JD Picks</button>
            <button class="btn-compare" onclick="compareRankings()">Compare to JD</button>
        </div>
    </div>
    
    <div class="number-picker-overlay" id="numberPickerOverlay" onclick="if(event.target === this) closeNumberPicker()">
        <div class="number-picker">
            <h3>Select Rank</h3>
            <div class="number-wheel" id="numberWheel">
                <!-- Numbers 1-11 will be generated here -->
            </div>
            <div class="picker-buttons">
                <button class="btn-reset" onclick="closeNumberPicker()">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        const originalStories = [
            {
                        "rank": 1,
                        "title": "Trump: States 'Undo' SNAP Payouts.",
                        "reason": "42 million Americans depend on SNAP. Newest test in battle between Executive and Judicial branches. Political pain of hunger increases human stakes of political fight.",
                        "reasonExpanded": "Lower courts forced payments, saying admin's refusal \"arbitrary and capricious\" causing \"irreparable harm\". Some states paid out benefits. Then SCOTUS (Jackson) issued a temporary \"administrative stay\"—not a ruling on the merits—based on the \"separation of powers\" argument that judges can't \"dictate... how scarce federal funds should be spent\". Then Admin. asked state to \"undo,\" what they'd paid.",
                        "type": "serious",
                        "newsRank": "1st",
                        "communityRank": "1st",
                        "sources": [
                                    {
                                                "outlet": "Indian Express",
                                                "url": "https://indianexpress.com/article/world/trump-administration-demands-states-undo-full-snap-payouts-as-states-warn-of-catastrophic-impact-10355912/"
                                    },
                                    {
                                                "outlet": "OPB",
                                                "url": "https://www.opb.org/article/2025/11/09/trump-administration-demands-states-undo-full-snap-payouts-as-states-warn-of-catastrophic-impact/"
                                    }
                        ]
            },
            {
                        "rank": 2,
                        "title": "Flight Cancellations",
                        "reason": "3.5 million affected; 2,500 flights cancelled.",
                        "reasonExpanded": "Straining systems. 25% of Americans travel once a year. Wider population than those who receive direct benefits. Affects wider economic activity. Could change political dynamic. Previous shutdowns ended when travel snarls were caused.",
                        "type": "serious",
                        "newsRank": "2nd",
                        "communityRank": "2nd",
                        "sources": [
                                    {
                                                "outlet": "AP News",
                                                "url": "https://apnews.com/article/shutdown-reduced-flights-what-to-know-a7feaf54f65567d180ae5a232cb0bcb4"
                                    },
                                    {
                                                "outlet": "Star Tribune",
                                                "url": "https://www.startribune.com/travelers-soldier-on-through-msp-delays-cancellations/601520377"
                                    },
                                    {
                                                "outlet": "The Guardian",
                                                "url": "https://www.theguardian.com/us-news/2025/nov/08/flight-cancellations-government-shutdown"
                                    }
                        ]
            },
            {
                        "rank": 3,
                        "title": "Ukraine Tripple Threat.",
                        "reason": "Russian launch of 450+ missiles and drones targeting two nuclear plants risks a catastrophic meltdown that poisons the continent of Europe. Territory of Pokrovsk is slipping. U.S. shutdown cut off $5 billion in weapons so they can't effectively shoot back.",
                        "reasonExpanded": "That barrage is a massive (sign of Russ. Capacity). Loss of life: at least seven people. 16-hour power cuts. Pokrovsk's a breach of Ukraine's eastern front in the Donetsk region.",
                        "type": "serious",
                        "newsRank": "3rd",
                        "communityRank": "3rd",
                        "sources": [
                                    {
                                                "outlet": "Al Jazeera",
                                                "url": "https://www.aljazeera.com/news/2025/11/09/russia-ukraine-war-list-of-key-events-day-1354"
                                    },
                                    {
                                                "outlet": "RNZ",
                                                "url": "https://www.rnz.co.nz/news/world/578314/russian-attacks-target-nuclear-substations-kill-seven-ukraine-says"
                                    }
                        ]
            },
            {
                        "rank": 4,
                        "title": "A House-Size Spider Web",
                        "reason": "Universal zing of spider stories. Natural wonder.",
                        "reasonExpanded": "The story's significance is not in its political or economic weight, but in its total lack of it. It functions as an essential \"palate cleanser\" for a serious news diet.",
                        "type": "wonder",
                        "newsRank": "4th",
                        "communityRank": "4th",
                        "sources": [
                                    {
                                                "outlet": "Times of India",
                                                "url": "https://timesofindia.indiatimes.com/world/europe/worlds-largest-spiderweb-found-in-europe-over-111000-spiders-inside/articleshow/125109293.cms"
                                    },
                                    {
                                                "outlet": "Indian Express",
                                                "url": "https://indianexpress.com/article/lifestyle/pets-animals/the-worlds-largest-spider-web-spread-across-roughly-1140-square-feet-found-in-a-hidden-sulfur-cave-10352619/"
                                    }
                        ]
            },
            {
                        "rank": 5,
                        "title": "U.S. Federal Judge Resigns.",
                        "reason": "Judges don't usually resign in this fashion. Reagan appointee diminishes charges of rank partisanship. Writing in The Atlantic, accuses Trump of \"using the law for partisan purposes.\" Protecting friends. Targeting enemies strikes at core of government functions.",
                        "reasonExpanded": "Significant data point in ongoing battle between Trump and courts.",
                        "type": "serious",
                        "newsRank": "5th",
                        "communityRank": "5th",
                        "sources": [
                                    {
                                                "outlet": "India Today",
                                                "url": "https://www.indiatoday.in/world/us-news/story/mark-wolf-resigns-federal-judge-condemns-trump-partisan-law-use-glbs-2816344-2025-11-10"
                                    },
                                    {
                                                "outlet": "Bloomberg Law",
                                                "url": "https://news.bloomberglaw.com/us-law-week/reagan-judge-says-he-quit-bench-to-speak-out-against-trump"
                                    }
                        ]
            },
            {
                        "rank": 6,
                        "title": "2016 Russia Probe officials subpoenaed.",
                        "reason": "This escalates the Trump administration's investigation of those who investigated him. Subpoenaed: former CIA Director John Brennan, former FBI officials Peter Strzok and Lisa Page, and former Director of National Intelligence James Clapper.",
                        "reasonExpanded": "The subpoenas are part of a stated \"retribution campaign\" against Trump's \"political adversaries\". The investigation is pursuing a \"grand conspiracy\" theory that sources say is \"unsupported by the evidence\". This same campaign has raised concerns in the Senate about a potential indictment of Sen. Adam Schiff.",
                        "type": "serious",
                        "newsRank": "6th",
                        "communityRank": "6th",
                        "sources": [
                                    {
                                                "outlet": "CBS News",
                                                "url": "https://www.cbsnews.com/news/grand-jury-cia-john-brennan-fbi-officials-trump-russia-probe-subpoena/"
                                    },
                                    {
                                                "outlet": "Washington Examiner",
                                                "url": "https://www.washingtonexaminer.com/news/justice/3880049/john-brennan-other-officials-subpoenaed-trump-russia-probe/"
                                    },
                                    {
                                                "outlet": "The Print",
                                                "url": "https://theprint.in/world/former-cia-boss-ex-fbi-officials-subpoenaed-in-doj-probe-fox-news-digital-reports/2779761/"
                                    }
                        ]
            },
            {
                        "rank": 7,
                        "title": "Infants with Botulism/Formula recall.",
                        "reason": "13 kids hospitalized in 10 states. ByHeart formula poses direct threat to infants. Parents need immediate action.",
                        "reasonExpanded": "No such thing as \"a little light botulism.\" it's a form of paralysis caused by a potent neurotoxin. Requires intensive care. Ten states is a lot. Infant botulism is very rare. When you suddenly get 13 cases across 10 states (Arizona, California, Illinois, Minnesota, New Jersey, Oregon, Pennsylvania, Rhode Island, Texas, and Washington) all linked to one product, it signals a systemic failure.",
                        "type": "serious",
                        "newsRank": "6th",
                        "communityRank": "6th",
                        "sources": [
                                    {
                                                "outlet": "CDC",
                                                "url": "https://www.cdc.gov/botulism/outbreaks-investigations/infant-formula-nov-2025/investigation.html"
                                    },
                                    {
                                                "outlet": "Times of India",
                                                "url": "https://timesofindia.indiatimes.com/life-style/health-fitness/health-news/infants-fall-sick-in-10-us-states-after-consuming-popular-baby-formula/articleshow/125199640.cms"
                                    }
                        ]
            },
            {
                        "rank": 8,
                        "title": "White-Collar Job Market Freezes; Shutdown Blinds Analysts",
                        "reason": "A key economic indicator, tech hiring, is down 27% year-over-year. The 40-day shutdown has blocked the official jobs report for \"two consecutive months\", meaning Federal Reserve and businesses can't plan or take measures to avoid a recession if one is coming.",
                        "reasonExpanded": "Signal of a \"bipolar economy\": AI and Wall Street are thriving while \"a lot of the middle class is getting hit\". Businesses state they aren't hiring. Connecticut Gov. Lamont, whose state's economy is tied to the financial sector, warned these are \"the early signs of what could be a potential recession\" as laid-off \"Corporate America\" workers face a \"hellish job market\".",
                        "type": "serious",
                        "newsRank": "8th",
                        "communityRank": "8th",
                        "sources": [
                                    {
                                                "outlet": "Investopedia",
                                                "url": "https://www.investopedia.com/data-drought-deepens-as-second-key-jobs-report-goes-unreported-11844989"
                                    }
                        ]
            },
            {
                        "rank": 9,
                        "title": "NYT: US part of UN-Defined Torture",
                        "reason": "The U.S. government is now implicated in torture.",
                        "reasonExpanded": "A NYT investigation found that 200+ Venezuelan men deported by the U.S. to an El Salvadoran prison were beaten and sexually assaulted by guards. An independent forensic analysis concluded these acts meet the UN's definition of torture. This isn't an isolated event; it's a direct consequence of the administration's immigration policy which has taken a hard line, including: ending Temporary Protected Status for 600,000 Venezuelans, conducting a \"two-month\" immigration crackdown in cities like Chicago, and deporting undocumented immigrants \"without due process\".",
                        "type": "serious",
                        "newsRank": "9th",
                        "communityRank": "9th",
                        "sources": [
                                    {
                                                "outlet": "NILC",
                                                "url": "https://www.nilc.org/resources/tracking-the-cecot-disappearances/"
                                    },
                                    {
                                                "outlet": "Latin News",
                                                "url": "https://www.latinnews.com/component/k2/item/106581-venezuela-investigation-into-alleged-torture-of-deportees-in-el-salvador.html"
                                    },
                                    {
                                                "outlet": "Human Rights First",
                                                "url": "https://humanrightsfirst.org/library/uzra-zeyas-remarks-at-the-universal-periodic-review-side-event/"
                                    }
                        ]
            },
            {
                        "rank": 10,
                        "title": "Hamas Returns Remains of Israeli Soldier.",
                        "reason": "Under U.S.-brokered peace deal, Hamas committed to returning 28 sets of remains. This brings \"bitter closure\" to an 11-year national ordeal for Israel and is also a key test of the current, rocky ceasefire.",
                        "reasonExpanded": "Israel accuses Hamas of slow-walking for leverage, while Hamas claims delays are due to the difficulty of digging up bodies from rubble. How that dispute gets resolved will determine if peace deal holds.",
                        "type": "serious",
                        "newsRank": "9th",
                        "communityRank": "9th",
                        "sources": [
                                    {
                                                "outlet": "Washington Examiner",
                                                "url": "https://www.washingtonexaminer.com/news/world/3880436/hamas-returns-body-israeli-soldier-2014"
                                    },
                                    {
                                                "outlet": "FDD",
                                                "url": "https://www.fdd.org/analysis/2025/11/10/remains-of-idf-officer-held-captive-by-hamas-for-more-than-a-decade-finally-released/"
                                    }
                        ]
            },
            {
                        "rank": 11,
                        "title": "Robot Woks in Los Angeles",
                        "reason": "An \"automatic woks\" is no work at all. Not just Gee Whiz, but a story of innovation to the familiar, everyday experience of dining.",
                        "reasonExpanded": "This is a high-diversion story that succeeds by being low-stakes and fascinating. Its value comes from its focus on invention in a relatable, non-political space (food).",
                        "type": "joy",
                        "newsRank": "11th",
                        "communityRank": "11th",
                        "sources": [
                                    {
                                                "outlet": "RoboWok",
                                                "url": "http://robowok.net/Aboutus.aspx?ClassID=2"
                                    },
                                    {
                                                "outlet": "BC RE LA",
                                                "url": "https://bcre.la/the-robots-are-coming-for-chinese-food-next/"
                                    },
                                    {
                                                "outlet": "LA Voice",
                                                "url": "https://lavoice.com/los-angeles-restaurant-tigawok-brings-chinese-food-and-robots-together/"
                                    }
                        ]
            }
];
        const stories = JSON.parse(JSON.stringify(originalStories));
        
        // Shuffle function using Fisher-Yates algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Start with scrambled order and save it for reset
        let initialScrambledOrder = shuffleArray(stories);
        let currentOrder = [...initialScrambledOrder];
        let myPicks = null; // Store user's saved ranking
        let draggedElement = null;
        let draggedIndex = null;
        let rankingsRevealed = false;
        let currentPickerIndex = null;
        
        window.addEventListener('DOMContentLoaded', () => {
            renderStories();
            initNumberPicker();
        });
        
        function renderStories() {
            const storyList = document.getElementById('storyList');
            storyList.innerHTML = '';
            currentOrder.forEach((story, index) => {
                const storyRow = document.createElement('div');
                storyRow.className = 'story-row ' + story.type;
                storyRow.id = 'story-' + index;
                
                // Rank number (clickable for number picker)
                const rankDiv = document.createElement('div');
                rankDiv.className = 'rank-number';
                rankDiv.id = 'rank-display-' + index;
                rankDiv.textContent = (index + 1);
                rankDiv.title = 'Click to jump';
                
                // Click to open number picker
                rankDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openNumberPicker(index);
                });
                rankDiv.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                storyRow.appendChild(rankDiv);
                
                // Story content area
                const storyContent = document.createElement('div');
                storyContent.className = 'story-content';
                
                // Title row with "more" button
                const titleRow = document.createElement('div');
                titleRow.className = 'story-title-row';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'story-title';
                
                // Add type tag for joy/wonder stories at the start of title
                if (story.type === 'joy' || story.type === 'wonder') {
                    const typeTag = document.createElement('span');
                    typeTag.className = 'story-type-tag ' + story.type;
                    typeTag.textContent = story.type;
                    titleDiv.appendChild(typeTag);
                }
                
                const titleText = document.createElement('span');
                titleText.className = 'story-title-text';
                titleText.textContent = story.title;
                titleDiv.appendChild(titleText);
                
                const moreButton = document.createElement('span');
                moreButton.className = 'more-button';
                moreButton.textContent = 'more';
                moreButton.onclick = function(e) {
                    e.stopPropagation();
                    toggleExpanded(index);
                };
                moreButton.ondragstart = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                titleRow.appendChild(titleDiv);
                titleRow.appendChild(moreButton);
                storyContent.appendChild(titleRow);
                
                // Expanded content (hidden by default)
                const expandedContent = document.createElement('div');
                expandedContent.className = 'expanded-content';
                expandedContent.id = 'expanded-' + index;
                
                // Reason text
                const reasonText = document.createElement('div');
                reasonText.className = 'reason-text';
                reasonText.textContent = story.reason;
                expandedContent.appendChild(reasonText);
                
                // Expanded reasoning
                if (story.reasonExpanded) {
                    const expandedReasonText = document.createElement('div');
                    expandedReasonText.className = 'expanded-reason-text';
                    expandedReasonText.textContent = story.reasonExpanded;
                    expandedContent.appendChild(expandedReasonText);
                }
                
                // Sources
                if (story.sources && story.sources.length > 0) {
                    const sourcesContainer = document.createElement('div');
                    sourcesContainer.className = 'sources-container';
                    
                    const sourcesLabel = document.createElement('div');
                    sourcesLabel.className = 'sources-label';
                    sourcesLabel.textContent = 'Sources';
                    sourcesContainer.appendChild(sourcesLabel);
                    
                    const sourcesList = document.createElement('div');
                    sourcesList.className = 'sources-list';
                    
                    story.sources.forEach(source => {
                        const sourceLink = document.createElement('a');
                        sourceLink.className = 'source-link';
                        sourceLink.textContent = source.outlet;
                        sourceLink.href = source.url;
                        sourceLink.target = '_blank';
                        sourceLink.rel = 'noopener noreferrer';
                        sourceLink.onclick = function(e) {
                            e.stopPropagation();
                        };
                        sourcesList.appendChild(sourceLink);
                    });
                    
                    sourcesContainer.appendChild(sourcesList);
                    expandedContent.appendChild(sourcesContainer);
                }
                
                storyContent.appendChild(expandedContent);
                storyRow.appendChild(storyContent);
                
                // Make entire row draggable
                storyRow.draggable = true;
                let isDraggingRow = false;
                
                // Desktop drag events on entire row
                storyRow.addEventListener('dragstart', (e) => {
                    // Don't start drag if clicking on rank number or more button
                    if (e.target.classList.contains('rank-number') || 
                        e.target.classList.contains('more-button')) {
                        e.preventDefault();
                        return;
                    }
                    
                    isDraggingRow = true;
                    draggedElement = storyRow;
                    draggedIndex = index;
                    setTimeout(() => storyRow.classList.add('dragging'), 0);
                    if (e.dataTransfer) {
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });
                
                storyRow.addEventListener('dragend', (e) => {
                    isDraggingRow = false;
                    storyRow.classList.remove('dragging');
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                });
                
                storyRow.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer) {
                        e.dataTransfer.dropEffect = 'move';
                    }
                    if (draggedElement && draggedElement !== storyRow) {
                        storyRow.classList.add('drag-over');
                    }
                });
                
                storyRow.addEventListener('dragleave', (e) => {
                    storyRow.classList.remove('drag-over');
                });
                
                storyRow.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== storyRow) {
                        const allRows = [...document.querySelectorAll('.story-row')];
                        const draggedIdx = allRows.indexOf(draggedElement);
                        const targetIdx = allRows.indexOf(storyRow);
                        
                        [currentOrder[draggedIdx], currentOrder[targetIdx]] = 
                        [currentOrder[targetIdx], currentOrder[draggedIdx]];
                        
                        renderStories();
                    }
                    storyRow.classList.remove('drag-over');
                });
                
                // Mobile touch events on entire row
                let touchStartX = 0;
                let touchStartY = 0;
                let isTouchDragging = false;
                let touchMoved = false;
                let touchTarget = null;
                
                storyRow.addEventListener('touchstart', (e) => {
                    touchTarget = e.target;
                    // Don't start drag if touching rank number or more button
                    if (e.target.classList.contains('rank-number') || 
                        e.target.classList.contains('more-button')) {
                        return;
                    }
                    
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    isTouchDragging = false;
                    touchMoved = false;
                    
                    // Visual feedback
                    storyRow.style.transform = 'scale(1.02)';
                    storyRow.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                }, {passive: true});
                
                storyRow.addEventListener('touchmove', (e) => {
                    // Don't drag if started on rank number or more button
                    if (touchTarget && (touchTarget.classList.contains('rank-number') || 
                        touchTarget.classList.contains('more-button'))) {
                        return;
                    }
                    
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    const threshold = 10; // Increased threshold to allow scrolling
                    
                    if (deltaX > threshold || deltaY > threshold) {
                        touchMoved = true;
                    }
                    
                    // Only start dragging if horizontal movement is greater than vertical
                    // This allows vertical scrolling
                    if (touchMoved && !isTouchDragging && deltaX > deltaY) {
                        isTouchDragging = true;
                        draggedElement = storyRow;
                        draggedIndex = index;
                        storyRow.classList.add('dragging');
                    }
                    
                    // Only prevent default if we're actually dragging
                    if (isTouchDragging) {
                        e.preventDefault();
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetRow = elementBelow?.closest('.story-row');
                        
                        document.querySelectorAll('.story-row').forEach(row => {
                            row.classList.remove('drag-over');
                        });
                        
                        if (targetRow && targetRow !== storyRow) {
                            targetRow.classList.add('drag-over');
                        }
                    }
                }, {passive: false});
                
                storyRow.addEventListener('touchend', (e) => {
                    // Reset visual feedback
                    storyRow.style.transform = '';
                    storyRow.style.boxShadow = '';
                    
                    if (isTouchDragging) {
                        e.preventDefault();
                        const touch = e.changedTouches[0];
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetRow = elementBelow?.closest('.story-row');
                        
                        if (targetRow && targetRow !== draggedElement) {
                            const allRows = [...document.querySelectorAll('.story-row')];
                            const draggedIdx = allRows.indexOf(draggedElement);
                            const targetIdx = allRows.indexOf(targetRow);
                            
                            if (draggedIdx !== -1 && targetIdx !== -1) {
                                [currentOrder[draggedIdx], currentOrder[targetIdx]] = 
                                [currentOrder[targetIdx], currentOrder[draggedIdx]];
                                
                                renderStories();
                            }
                        }
                    }
                    
                    isTouchDragging = false;
                    touchMoved = false;
                    touchTarget = null;
                    draggedElement = null;
                    
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over', 'dragging');
                    });
                }, {passive: false});
                
                storyRow.addEventListener('touchcancel', (e) => {
                    storyRow.style.transform = '';
                    storyRow.style.boxShadow = '';
                    isTouchDragging = false;
                    touchMoved = false;
                    touchTarget = null;
                    draggedElement = null;
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over', 'dragging');
                    });
                });
                
                storyList.appendChild(storyRow);
            });
        }
        
        function toggleExpanded(index) {
            const expandedContent = document.getElementById('expanded-' + index);
            const moreButtons = document.querySelectorAll('.more-button');
            const moreButton = moreButtons[index];
            
            if (expandedContent.classList.contains('visible')) {
                expandedContent.classList.remove('visible');
                moreButton.textContent = 'more';
            } else {
                expandedContent.classList.add('visible');
                moreButton.textContent = 'less';
            }
        }
        
        function compareRankings() {
            rankingsRevealed = !rankingsRevealed;
            
            currentOrder.forEach((story, userIndex) => {
                const rankDisplay = document.getElementById('rank-display-' + userIndex);
                const userRank = userIndex + 1;
                const jdRank = story.rank;
                
                if (rankingsRevealed) {
                    rankDisplay.classList.add('revealed');
                    rankDisplay.textContent = userRank + ' / JD:' + jdRank;
                    rankDisplay.title = 'Your rank / JD\'s rank';
                } else {
                    rankDisplay.classList.remove('revealed');
                    rankDisplay.textContent = userRank;
                    rankDisplay.title = 'Click to jump';
                }
            });
            
            if (rankingsRevealed) {
                // Calculate differences and generate summary
                const differences = currentOrder.map((story, userIndex) => ({
                    story: story,
                    userRank: userIndex + 1,
                    jdRank: story.rank,
                    diff: Math.abs((userIndex + 1) - story.rank)
                }));
                
                // Sort by biggest difference
                differences.sort((a, b) => b.diff - a.diff);
                
                // Find stories that moved most
                const biggest = differences[0];
                const secondBiggest = differences[1];
                
                let summary = '';
                
                if (biggest.diff === 0) {
                    summary = 'Perfect match! You and JD ranked all stories identically.';
                } else {
                    // First sentence: biggest mover
                    const biggestDir = biggest.userRank < biggest.jdRank ? 'higher' : 'lower';
                    const biggestTitle = biggest.story.title.length > 40 ? 
                        biggest.story.title.substring(0, 40) + '...' : 
                        biggest.story.title;
                    summary = `Your biggest difference: you ranked "${biggestTitle}" ${biggestDir} (#${biggest.userRank} vs JD's #${biggest.jdRank}). `;
                    
                    // Second sentence: list exact matches by story number
                    const exactMatches = differences.filter(d => d.diff === 0);
                    if (exactMatches.length > 0) {
                        const matchNumbers = exactMatches.map(m => m.story.rank).sort((a, b) => a - b);
                        if (matchNumbers.length === 1) {
                            summary += `You agreed on story #${matchNumbers[0]}.`;
                        } else if (matchNumbers.length === 2) {
                            summary += `You agreed on stories #${matchNumbers[0]} and #${matchNumbers[1]}.`;
                        } else {
                            const lastNum = matchNumbers.pop();
                            summary += `You agreed on stories #${matchNumbers.join(', #')}, and #${lastNum}.`;
                        }
                    } else {
                        // No exact matches, mention second biggest difference
                        if (secondBiggest.diff > 0) {
                            const secondDir = secondBiggest.userRank < secondBiggest.jdRank ? 'higher' : 'lower';
                            const secondTitle = secondBiggest.story.title.length > 40 ? 
                                secondBiggest.story.title.substring(0, 40) + '...' : 
                                secondBiggest.story.title;
                            summary += `Also notable: "${secondTitle}" ranked ${secondDir} (#${secondBiggest.userRank} vs #${secondBiggest.jdRank}).`;
                        }
                    }
                }
                
                updateInfoText(summary, true);
            } else {
                updateInfoText("", false);
            }
        }
        
        function resetOrder() {
            currentOrder = JSON.parse(JSON.stringify(initialScrambledOrder));
            rankingsRevealed = false;
            renderStories();
            showTemporaryMessage("Back to scrambled order");
        }
        
        function showMyPicks() {
            if (!myPicks) {
                // First time: save current order
                myPicks = JSON.parse(JSON.stringify(currentOrder));
                showTemporaryMessage("Your ranking saved!");
            } else {
                // Check if current order matches saved picks
                const currentJSON = JSON.stringify(currentOrder.map(s => s.rank));
                const savedJSON = JSON.stringify(myPicks.map(s => s.rank));
                
                if (currentJSON === savedJSON) {
                    // Already showing saved picks, so update the save
                    myPicks = JSON.parse(JSON.stringify(currentOrder));
                    showTemporaryMessage("Your ranking updated!");
                } else {
                    // Different order, so restore saved picks
                    currentOrder = JSON.parse(JSON.stringify(myPicks));
                    showTemporaryMessage("Restored your saved ranking");
                }
            }
            rankingsRevealed = false;
            renderStories();
        }
        
        function showJDPicks() {
            // Show John's original ranking (sorted by rank field)
            currentOrder = JSON.parse(JSON.stringify(originalStories));
            rankingsRevealed = false;
            renderStories();
            showTemporaryMessage("Showing JD's ranking");
        }
        
        function showTemporaryMessage(message) {
            const infoText = document.getElementById('infoText');
            infoText.textContent = message;
            infoText.style.display = 'block';
            setTimeout(() => {
                infoText.style.display = 'none';
            }, 2000);
        }
        
        function updateInfoText(message, isPersistent = false) {
            const infoText = document.getElementById('infoText');
            if (message) {
                infoText.textContent = message;
                infoText.style.display = 'block';
            } else {
                infoText.textContent = '';
                infoText.style.display = 'none';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function initNumberPicker() {
            const numberWheel = document.getElementById('numberWheel');
            for (let i = 1; i <= 11; i++) {
                const numOption = document.createElement('div');
                numOption.className = 'number-option';
                numOption.textContent = i;
                numOption.onclick = () => selectRank(i);
                numberWheel.appendChild(numOption);
            }
        }
        
        function openNumberPicker(index) {
            currentPickerIndex = index;
            const overlay = document.getElementById('numberPickerOverlay');
            overlay.classList.add('active');
            
            // Highlight current position
            const currentRank = index + 1;
            document.querySelectorAll('.number-option').forEach((opt, i) => {
                if (i + 1 === currentRank) {
                    opt.classList.add('current');
                } else {
                    opt.classList.remove('current');
                }
            });
        }
        
        function closeNumberPicker() {
            document.getElementById('numberPickerOverlay').classList.remove('active');
            currentPickerIndex = null;
        }
        
        function selectRank(newRank) {
            if (currentPickerIndex === null) return;
            
            const oldIndex = currentPickerIndex;
            const newIndex = newRank - 1;
            
            if (oldIndex !== newIndex) {
                // Remove item from old position
                const item = currentOrder.splice(oldIndex, 1)[0];
                // Insert at new position
                currentOrder.splice(newIndex, 0, item);
                renderStories();
            }
            
            closeNumberPicker();
        }
    </script>
</body>
</html>
