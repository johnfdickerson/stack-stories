<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack Stories 2.0 by John Dickerson</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .phone-frame {
            width: 375px;
            background: white;
            border-radius: 40px;
            border: 8px solid #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            max-height: 90vh;
        }
        .header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        .header h1 {
            font-size: 18px;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 12px;
            color: #666;
        }
        .column-header-row {
            display: grid;
            grid-template-columns: 25px 1fr 30px 1.2fr;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            font-size: 10px;
            background: #f9f9f9;
            align-items: center;
        }
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .story-row {
            display: grid;
            grid-template-columns: 25px 1fr 30px 1.2fr;
            gap: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: default;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
            user-select: none;
            align-items: start;
        }
        .story-row:active {
            cursor: default;
        }
        .story-row.serious {
            background: white;
        }
        .story-row.joy {
            background: #FEF3C7;
        }
        .story-row.wonder {
            background: #EDE9FE;
        }
        .story-row.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .story-row.drag-over {
            border-top: 3px solid #0066cc;
        }
        .rank-number {
            font-size: 12px;
            font-weight: bold;
            color: #1a1a1a;
            text-align: center;
            line-height: 1.2;
            cursor: pointer;
            user-select: text;
        }
        .rank-number.revealed {
            font-size: 10px;
        }
        .drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            padding: 8px 8px;
            opacity: 0.5;
            transition: opacity 0.2s;
            touch-action: none;
            min-width: 30px;
        }
        .drag-handle:active {
            cursor: grabbing;
            opacity: 1;
        }
        .drag-handle:hover {
            opacity: 0.8;
        }
        .drag-handle-line {
            width: 3px;
            height: 30px;
            background: #666;
            border-radius: 2px;
        }
        .story-row.dragging .drag-handle {
            opacity: 1;
        }
        .story-row.dragging .drag-handle-line {
            background: #0066cc;
        }
        .story-title {
            cursor: pointer;
            user-select: text;
        }
        .story-title a {
            color: #0066cc;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            line-height: 1.2;
        }
        .story-title a:hover {
            text-decoration: underline;
        }
        .reason-label {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .reason-label.expanded {
            -webkit-line-clamp: unset;
            overflow: visible;
        }
        .reason-more {
            font-size: 10px;
            color: #0066cc;
            cursor: pointer;
            font-weight: 500;
            margin-top: 2px;
            display: inline-block;
        }
        .sources-container {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: none;
        }
        .sources-container.visible {
            display: block;
        }
        .sources-label {
            font-size: 9px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .source-link {
            font-size: 9px;
            padding: 2px 6px;
            background: #e8f1ff;
            color: #0066cc;
            border-radius: 3px;
            text-decoration: none;
            cursor: pointer;
            border: 1px solid #b3d9ff;
            transition: all 0.2s;
        }
        .source-link:hover {
            background: #0066cc;
            color: white;
        }
        .info-text {
            padding: 12px 16px;
            font-size: 11px;
            color: #666;
            border-top: 1px solid #eee;
            min-height: 40px;
        }
        .footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid #eee;
        }
        button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-vote {
            background: #0066cc;
            color: white;
        }
        .btn-vote:hover {
            background: #0052a3;
        }
        .btn-reset {
            background: #f0f0f0;
            color: #333;
        }
        .btn-reset:hover {
            background: #e0e0e0;
        }
        .btn-my-picks {
            background: #8b5cf6;
            color: white;
        }
        .btn-my-picks:hover {
            background: #7c3aed;
        }
        .btn-jd-picks {
            background: #f59e0b;
            color: white;
        }
        .btn-jd-picks:hover {
            background: #d97706;
        }
        .btn-compare {
            background: #10b981;
            color: white;
        }
        .btn-compare:hover {
            background: #059669;
        }
        .btn-compare:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .number-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .number-picker-overlay.active {
            display: flex;
        }
        .number-picker {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .number-picker h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #333;
        }
        .number-wheel {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 280px;
            margin-bottom: 16px;
        }
        .number-option {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .number-option:hover {
            background: #e0e0e0;
            border-color: #0066cc;
        }
        .number-option.current {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        .picker-buttons {
            display: flex;
            gap: 8px;
        }
        .picker-buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="header">
            <h1>Stack Stories 2.0</h1>
            <p>by John Dickerson</p>
            <p style="font-size: 11px; margin-top: 4px;">November 9, 2025</p>
        </div>
        <div class="column-header-row">
            <div>#</div>
            <div>Story</div>
            <div></div>
            <div>Reason</div>
        </div>
        <div class="content" id="storyList">
            <!-- Stories will be generated here -->
        </div>
        <div class="info-text" id="infoText">
            Rank today's news by importance: Drag | to reorder • Click # to jump • Tap title for sources • Compare to see JD's ranking
        </div>
        <div class="footer">
            <button class="btn-reset" onclick="resetOrder()">Reset</button>
            <button class="btn-my-picks" onclick="showMyPicks()">My Picks</button>
            <button class="btn-jd-picks" onclick="showJDPicks()">JD Picks</button>
            <button class="btn-compare" onclick="compareRankings()">Compare to JD</button>
        </div>
    </div>
    
    <div class="number-picker-overlay" id="numberPickerOverlay" onclick="if(event.target === this) closeNumberPicker()">
        <div class="number-picker">
            <h3>Select Rank</h3>
            <div class="number-wheel" id="numberWheel">
                <!-- Numbers 1-11 will be generated here -->
            </div>
            <div class="picker-buttons">
                <button class="btn-reset" onclick="closeNumberPicker()">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        const originalStories = [
            {
                        "rank": 1,
                        "title": "Trump demands States 'Undo' SNAP Payouts.",
                        "reason": "42 million Americans depend on SNAP. Newest test in battle between Executive and Judicial branches. Political pain of hunger increases human stakes of political fight.",
                        "reasonExpanded": "Lower courts forced payments, saying admin's refusal \"arbitrary and capricious\" causing \"irreparable harm\". Some states paid out benefits. Then SCOTUS (Jackson) issued a temporary \"administrative stay\" - not a ruling on the merits - based on the \"separation of powers\" argument that judges can't \"dictate... how scarce federal funds should be spent\". Then Admin. asked state to \"undo,\" what they'd paid.",
                        "type": "serious",
                        "newsRank": "1st",
                        "communityRank": "1st",
                        "sources": [
                                    {
                                                "outlet": "Fortune",
                                                "url": "https://fortune.com/2025/11/09/trump-administration-demands-states-undo-full-snap-payouts/"
                                    },
                                    {
                                                "outlet": "MS Free Press",
                                                "url": "https://mississippifreepress.org/2025/11/08/trump-administration-demands-states-undo-full-snap-payouts/"
                                    },
                                    {
                                                "outlet": "SFGate",
                                                "url": "https://www.sfgate.com/news/article/trump-administration-demands-states-undo-snap-payouts-16838456.php"
                                    }
                        ]
            },
            {
                        "rank": 2,
                        "title": "Flight Cancellations",
                        "reason": "3.5 million affected; 2,500 flights cancelled.",
                        "reasonExpanded": "Straining systems. 25% of Americans travel once a year. Wider population than those who receive direct benefits. Affects wider economic activity. Could change political dynamic. Previous shutdowns ended when travel snarls were caused.",
                        "type": "serious",
                        "newsRank": "2nd",
                        "communityRank": "2nd",
                        "sources": [
                                    {
                                                "outlet": "NY Post",
                                                "url": "https://nypost.com/2025/11/09/us-airlines-cancel-more-than-2500-weekend-flights-government-shutdown/"
                                    },
                                    {
                                                "outlet": "CTV News",
                                                "url": "https://www.ctvnews.ca/2025/11/08/us-airlines-cancel-more-than-2500-weekend-flights-largely-due-to-government-shutdown-1.6184543"
                                    },
                                    {
                                                "outlet": "Marca",
                                                "url": "https://marca.com/en/lifestyle/news/2025/11/09/flight-cancellations-surge-amid-government-shutdown/"
                                    }
                        ]
            },
            {
                        "rank": 3,
                        "title": "Ukraine: Russian Air Attack, City Capture, Stalled U.S. Aid",
                        "reason": "Russian launch of 450+ missiles and drones targeting two nuclear plants risks a catastrophic meltdown that poisons the continent of Europe. all Europe. Territory of Pokrovsk is slipping. U.S. shutdown cut off $5 billion in weapons so they can't effectively shoot back.",
                        "reasonExpanded": "That 450+ barrage is a massive, coordinated strike to overwhelm air defense, killing at least seven people and causing 16-hour power cuts. Pokrovsk's loss would mean a major strategic loss; the breach of Ukraine's eastern front in the Donetsk regioN.",
                        "type": "serious",
                        "newsRank": "3rd",
                        "communityRank": "3rd",
                        "sources": [
                                    {
                                                "outlet": "10 News",
                                                "url": "https://www.10news.com/2025/11/08/ukrainian-strikes-disrupt-power-heating-2-major-cities-russia/"
                                    },
                                    {
                                                "outlet": "YouTube News9",
                                                "url": "https://www.youtube.com/"
                                    },
                                    {
                                                "outlet": "CTV News",
                                                "url": "https://www.ctvnews.ca/"
                                    }
                        ]
            },
            {
                        "rank": 4,
                        "title": "A House-Size Spider Web",
                        "reason": "Universal zing of spider stories. Natural wonder.",
                        "reasonExpanded": "The story's significance is not in its political or economic weight, but in its total lack of it. It functions as an essential \"palate cleanser\" for a serious news diet.",
                        "type": "wonder",
                        "newsRank": "4th",
                        "communityRank": "4th",
                        "sources": []
            },
            {
                        "rank": 5,
                        "title": "U.S. Federal Judge Resigns: President's \"Partisan Use of Law\"",
                        "reason": "Judges don't usually resign in this fashion. Reagan appointee diminishes charges of rank partisanship. Writing in The Atlantic, accuses Trump of \"using the law for partisan purposes.\" Protecting friends. Targeting enemies strikes at core of government functions.",
                        "reasonExpanded": "Significant data point in ongoing battle between Trump and courts.",
                        "type": "serious",
                        "newsRank": "5th",
                        "communityRank": "5th",
                        "sources": []
            },
            {
                        "rank": 6,
                        "title": "Top Officials in 2016 Russia Probe subpoenaed.",
                        "reason": "This escalates the Trump administration's investigation of those who investigated him. Subpoenaed: former CIA Director John Brennan, former FBI officials Peter Strzok and Lisa Page, and former Director of National Intelligence James Clapper.",
                        "reasonExpanded": "The subpoenas are part of a stated \"retribution campaign\" against Trump's \"political adversaries\". The investigation, is pursuing a \"grand conspiracy\" theory that sources say is \"unsupported by the evidence\". This same campaign has raised concerns in the Senate about a potential indictment of Sen. Adam Schiff.",
                        "type": "serious",
                        "newsRank": "6th",
                        "communityRank": "6th",
                        "sources": []
            },
            {
                        "rank": 7,
                        "title": "13 Infants with Botulism Across 10 States; Formula Recall",
                        "reason": "ByHeart formula poses direct threat to infants. Parents need immediate action.",
                        "reasonExpanded": "No such thing as \"a little light botulism.\" it's a form of paralysis caused by a potent neurotoxin. Requires intensive care. Ten states is a lot. Infant botulism is very rare. when you suddenly get 13 cases across 10 states (Arizona, California, Illinois, Minnesota, New Jersey, Oregon, Pennsylvania, Rhode Island, Texas, and Washington) all linked to one product, it signals a systemic failure.",
                        "type": "serious",
                        "newsRank": "7th",
                        "communityRank": "7th",
                        "sources": []
            },
            {
                        "rank": 8,
                        "title": "White-Collar Job Market Freezes; Shutdown Blinds Analysts for Two Months",
                        "reason": "A key economic indicator, tech hiring, is down 27% year-over-year. The 40-day shutdown has blocked the official jobs report for \"two consecutive months\", mean Federal Reserve and businesses can't plan or take measures to avoid a recession if one is coming.",
                        "reasonExpanded": "Signal of a \"bipolar economy\": AI and Wall Street are thriving while \"a lot of the middle class is getting hit\". Businesses state they aren't hiring. Connecticut Gov. Lamont, whose state's economy is tied to the financial sector, warned these are \"the early signs of what could be a potential recession\" as laid-off \"Corporate America\" workers face a \"hellish job market\".",
                        "type": "serious",
                        "newsRank": "8th",
                        "communityRank": "8th",
                        "sources": []
            },
            {
                        "rank": 9,
                        "title": "NYT Probe Alleges US part of UN-Defined Torture",
                        "reason": "The U.S. government is now implicated in torture.",
                        "reasonExpanded": "A NYT investigation found that 200+ Venezuelan men deported by the U.S. to an El Salvadoran prison were beaten and sexually assaulted by guards . An independent forensic analysis concluded these acts meet the UN's definition of torture. This isn't an isolated event; it's a direct consequence of the administration's immigration policy which has taken a hard line, including: ending Temporary Protected Status for 600,000 Venezuelans , conducting a \"two-month\" immigration crackdown in cities like Chicago, and deporting undocumented immigrants \"without due process\".",
                        "type": "serious",
                        "newsRank": "9th",
                        "communityRank": "9th",
                        "sources": []
            },
            {
                        "rank": 10,
                        "title": "Hamas Returns Remains of Israeli Soldier Hadar Goldin After 11 Years",
                        "reason": "Under U.S.-brokered peace deal, Hamas committed to returning 28 sets of remains. This brings \"bitter closure\" to an 11-year national ordeal for Israel it is also a key test of the current, rocky ceasefire.",
                        "reasonExpanded": "Israel accuses Hamas of slow-walking for leverage, while Hamas claims delays are due to the difficulty of digging up bodies from rubble. How that dispute gets resolved will determine if peace deal holds.",
                        "type": "serious",
                        "newsRank": "10th",
                        "communityRank": "10th",
                        "sources": []
            },
            {
                        "rank": 11,
                        "title": "Robot Woks in Los Angeles",
                        "reason": "An \"automatic woks\" is no work at all. Not just Gee Whiz, but a story of innovation to the familiar, everyday experience of dining.",
                        "reasonExpanded": "This is a high-diversion story that succeeds by being low-stakes and fascinating. Its value comes from its focus on invention in a relatable, non-political space (food).",
                        "type": "joy",
                        "newsRank": "11th",
                        "communityRank": "11th",
                        "sources": []
            }
];
        const stories = JSON.parse(JSON.stringify(originalStories));
        
        // Shuffle function using Fisher-Yates algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Start with scrambled order and save it for reset
        let initialScrambledOrder = shuffleArray(stories);
        let currentOrder = [...initialScrambledOrder];
        let myPicks = null; // Store user's saved ranking
        let draggedElement = null;
        let draggedIndex = null;
        let rankingsRevealed = false;
        let currentPickerIndex = null;
        
        window.addEventListener('DOMContentLoaded', () => {
            renderStories();
            initNumberPicker();
        });
        function renderStories() {
            const storyList = document.getElementById('storyList');
            storyList.innerHTML = '';
            currentOrder.forEach((story, index) => {
                const storyRow = document.createElement('div');
                storyRow.className = 'story-row ' + story.type;
                storyRow.id = 'story-' + index;
                
                // Rank number with long-press
                const rankDiv = document.createElement('div');
                rankDiv.className = 'rank-number';
                rankDiv.id = 'rank-display-' + index;
                rankDiv.textContent = (index + 1);
                rankDiv.title = 'Click to select rank';
                
                // Click/tap to open number picker
                rankDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openNumberPicker(index);
                });
                
                storyRow.appendChild(rankDiv);
                
                // Story title
                const titleDiv = document.createElement('div');
                titleDiv.className = 'story-title';
                titleDiv.style.cursor = 'pointer';
                titleDiv.innerHTML = '<a href="#">' + escapeHtml(story.title) + '</a>';
                titleDiv.onclick = function(e) {
                    e.stopPropagation();
                    toggleSources(index);
                };
                storyRow.appendChild(titleDiv);
                
                // Drag handle
                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle';
                dragHandle.innerHTML = '<div class="drag-handle-line"></div>';
                storyRow.appendChild(dragHandle);
                
                // Reason section
                const reasonDiv = document.createElement('div');
                const reasonLabel = document.createElement('div');
                reasonLabel.className = 'reason-label ' + story.type;
                reasonLabel.id = 'reason-' + index;
                reasonLabel.textContent = story.reason;
                const moreButton = document.createElement('span');
                moreButton.className = 'reason-more';
                moreButton.textContent = 'more';
                moreButton.onclick = function(e) { 
                    e.stopPropagation();
                    toggleReason(e, index); 
                };
                reasonDiv.appendChild(reasonLabel);
                reasonDiv.appendChild(moreButton);
                
                // Sources container
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'sources-container';
                sourcesContainer.id = 'sources-' + index;
                
                if (story.sources && story.sources.length > 0) {
                    const sourcesLabel = document.createElement('div');
                    sourcesLabel.className = 'sources-label';
                    sourcesLabel.textContent = 'Sources';
                    sourcesContainer.appendChild(sourcesLabel);
                    
                    const sourcesList = document.createElement('div');
                    sourcesList.className = 'sources-list';
                    
                    story.sources.forEach(source => {
                        const sourceLink = document.createElement('a');
                        sourceLink.className = 'source-link';
                        sourceLink.textContent = source.outlet;
                        sourceLink.href = source.url;
                        sourceLink.target = '_blank';
                        sourceLink.rel = 'noopener noreferrer';
                        sourceLink.onclick = function(e) {
                            e.stopPropagation();
                        };
                        sourcesList.appendChild(sourceLink);
                    });
                    
                    sourcesContainer.appendChild(sourcesList);
                }
                reasonDiv.appendChild(sourcesContainer);
                storyRow.appendChild(reasonDiv);
                
                // Drag events - ONLY on drag handle for desktop
                dragHandle.draggable = true;
                dragHandle.addEventListener('dragstart', (e) => {
                    draggedElement = storyRow;
                    draggedIndex = index;
                    setTimeout(() => storyRow.classList.add('dragging'), 0);
                    if (e.dataTransfer) {
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });
                
                storyRow.addEventListener('dragend', (e) => {
                    storyRow.classList.remove('dragging');
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                });
                
                storyRow.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer) {
                        e.dataTransfer.dropEffect = 'move';
                    }
                    if (draggedElement && draggedElement !== storyRow) {
                        storyRow.classList.add('drag-over');
                    }
                });
                
                storyRow.addEventListener('dragleave', (e) => {
                    storyRow.classList.remove('drag-over');
                });
                
                storyRow.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== storyRow) {
                        const allRows = [...document.querySelectorAll('.story-row')];
                        const draggedIdx = allRows.indexOf(draggedElement);
                        const targetIdx = allRows.indexOf(storyRow);
                        
                        [currentOrder[draggedIdx], currentOrder[targetIdx]] = 
                        [currentOrder[targetIdx], currentOrder[draggedIdx]];
                        
                        renderStories();
                    }
                    storyRow.classList.remove('drag-over');
                });
                
                // Touch events - ONLY on drag handle for mobile
                let touchStartX = 0;
                let touchStartY = 0;
                let isTouchDragging = false;
                let touchMoved = false;
                let touchTimer = null;
                
                dragHandle.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    isTouchDragging = false;
                    touchMoved = false;
                }, {passive: true});
                
                dragHandle.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    const threshold = 5;
                    
                    if (deltaX > threshold || deltaY > threshold) {
                        touchMoved = true;
                    }
                    
                    if (touchMoved && !isTouchDragging) {
                        isTouchDragging = true;
                        draggedElement = storyRow;
                        draggedIndex = index;
                        storyRow.classList.add('dragging');
                    }
                    
                    if (isTouchDragging) {
                        e.preventDefault();
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetRow = elementBelow?.closest('.story-row');
                        
                        document.querySelectorAll('.story-row').forEach(row => {
                            row.classList.remove('drag-over');
                        });
                        
                        if (targetRow && targetRow !== storyRow) {
                            targetRow.classList.add('drag-over');
                        }
                    }
                }, {passive: false});
                
                dragHandle.addEventListener('touchend', (e) => {
                    if (isTouchDragging) {
                        e.preventDefault();
                        const touch = e.changedTouches[0];
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetRow = elementBelow?.closest('.story-row');
                        
                        if (targetRow && targetRow !== draggedElement) {
                            const allRows = [...document.querySelectorAll('.story-row')];
                            const draggedIdx = allRows.indexOf(draggedElement);
                            const targetIdx = allRows.indexOf(targetRow);
                            
                            if (draggedIdx !== -1 && targetIdx !== -1) {
                                [currentOrder[draggedIdx], currentOrder[targetIdx]] = 
                                [currentOrder[targetIdx], currentOrder[draggedIdx]];
                                
                                renderStories();
                            }
                        }
                    }
                    
                    isTouchDragging = false;
                    touchMoved = false;
                    draggedElement = null;
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over', 'dragging');
                    });
                }, {passive: false});
                
                dragHandle.addEventListener('touchcancel', (e) => {
                    isTouchDragging = false;
                    touchMoved = false;
                    draggedElement = null;
                    document.querySelectorAll('.story-row').forEach(row => {
                        row.classList.remove('drag-over', 'dragging');
                    });
                });
                
                storyList.appendChild(storyRow);
            });
        }
        function toggleSources(index) {
            const sourcesContainer = document.getElementById('sources-' + index);
            if (sourcesContainer) {
                sourcesContainer.classList.toggle('visible');
            }
        }
        function toggleReason(event, index) {
            event.stopPropagation();
            const reasonLabel = document.getElementById('reason-' + index);
            const moreButton = event.target;
            if (reasonLabel.classList.contains('expanded')) {
                reasonLabel.classList.remove('expanded');
                reasonLabel.textContent = stories.find(s => s.rank === currentOrder[index].rank).reason;
                moreButton.textContent = 'more';
            } else {
                reasonLabel.classList.add('expanded');
                const storyData = stories.find(s => s.rank === currentOrder[index].rank);
                const combinedText = storyData.reason + '\n\n' + storyData.reasonExpanded;
                reasonLabel.textContent = combinedText;
                moreButton.textContent = 'less';
            }
        }
        function resetOrder() {
            currentOrder = JSON.parse(JSON.stringify(initialScrambledOrder));
            rankingsRevealed = false;
            renderStories();
            updateInfoText("Back to scrambled order");
        }
        
        function showMyPicks() {
            if (!myPicks) {
                // First time: save current order
                myPicks = JSON.parse(JSON.stringify(currentOrder));
                updateInfoText("Your ranking saved! Click again to restore it.");
            } else {
                // Check if current order matches saved picks
                const currentJSON = JSON.stringify(currentOrder.map(s => s.rank));
                const savedJSON = JSON.stringify(myPicks.map(s => s.rank));
                
                if (currentJSON === savedJSON) {
                    // Already showing saved picks, so update the save
                    myPicks = JSON.parse(JSON.stringify(currentOrder));
                    updateInfoText("Your ranking updated!");
                } else {
                    // Different order, so restore saved picks
                    currentOrder = JSON.parse(JSON.stringify(myPicks));
                    updateInfoText("Restored your saved ranking");
                }
            }
            rankingsRevealed = false;
            renderStories();
        }
        
        function showJDPicks() {
            // Show John's original ranking (sorted by rank field)
            currentOrder = JSON.parse(JSON.stringify(originalStories));
            rankingsRevealed = false;
            renderStories();
            updateInfoText("Showing JD's ranking");
        }
        
        function compareRankings() {
            rankingsRevealed = !rankingsRevealed;
            
            currentOrder.forEach((story, userIndex) => {
                const rankDisplay = document.getElementById('rank-display-' + userIndex);
                const userRank = userIndex + 1;
                const jdRank = story.rank;
                
                if (rankingsRevealed) {
                    rankDisplay.classList.add('revealed');
                    rankDisplay.textContent = userRank + ' / JD:' + jdRank;
                    rankDisplay.title = 'Your rank / JD\'s rank';
                } else {
                    rankDisplay.classList.remove('revealed');
                    rankDisplay.textContent = userRank;
                    rankDisplay.title = 'Click to select rank';
                }
            });
            
            if (rankingsRevealed) {
                updateInfoText("Comparing your ranking to JD's");
            } else {
                updateInfoText("");
            }
        }
        
        function updateInfoText(message) {
            const infoText = document.getElementById('infoText');
            if (message) {
                infoText.innerHTML = '<strong>' + escapeHtml(message) + '</strong>';
                setTimeout(() => {
                    infoText.textContent = 'Rank today\'s news by importance: Drag | to reorder • Click # to jump • Tap title for sources • Compare to see JD\'s ranking';
                }, 2000);
            } else {
                infoText.textContent = 'Rank today\'s news by importance: Drag | to reorder • Click # to jump • Tap title for sources • Compare to see JD\'s ranking';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function initNumberPicker() {
            const numberWheel = document.getElementById('numberWheel');
            for (let i = 1; i <= 11; i++) {
                const numOption = document.createElement('div');
                numOption.className = 'number-option';
                numOption.textContent = i;
                numOption.onclick = () => selectRank(i);
                numberWheel.appendChild(numOption);
            }
        }
        
        function openNumberPicker(index) {
            currentPickerIndex = index;
            const overlay = document.getElementById('numberPickerOverlay');
            overlay.classList.add('active');
            
            // Highlight current position
            const currentRank = index + 1;
            document.querySelectorAll('.number-option').forEach((opt, i) => {
                if (i + 1 === currentRank) {
                    opt.classList.add('current');
                } else {
                    opt.classList.remove('current');
                }
            });
        }
        
        function closeNumberPicker() {
            document.getElementById('numberPickerOverlay').classList.remove('active');
            currentPickerIndex = null;
        }
        
        function selectRank(newRank) {
            if (currentPickerIndex === null) return;
            
            const oldIndex = currentPickerIndex;
            const newIndex = newRank - 1;
            
            if (oldIndex !== newIndex) {
                // Remove item from old position
                const item = currentOrder.splice(oldIndex, 1)[0];
                // Insert at new position
                currentOrder.splice(newIndex, 0, item);
                renderStories();
            }
            
            closeNumberPicker();
        }
    </script>
</body>
</html>
